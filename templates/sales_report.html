{% extends "layout.html" %}
{% block title %}Sales Report{% endblock %}

{% block head %}
{{ super() }}
<style>
    .report-section { margin-bottom: 40px; }
    .report-section h2 {
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 10px;
        margin-top: 20px;
    }
    .num { text-align: right; }
    tfoot tr.total-row {
        font-weight: bold;
        background-color: #e9ecef;
        border-top: 2px solid #ced4da;
    }
</style>
{% endblock %}


{% block content %}
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1>Sales Report</h1>
        <a href="{{ url_for('export_sales_report', start_date=start_date, end_date=end_date) }}" style="padding: 8px 15px; background-color: #28a745; color: white; text-decoration: none; border-radius: 5px;">Export Detailed CSV</a>
    </div>

    <form method="POST" action="{{ url_for('sales_report') }}" style="margin-bottom: 20px; background-color: #e9ecef; padding: 15px; border-radius: 5px;">
        <label for="start_date">Start Date:</label>
        <input type="date" name="start_date" id="start_date" value="{{ start_date }}">
        <label for="end_date" style="margin-left: 20px;">End Date:</label>
        <input type="date" name="end_date" id="end_date" value="{{ end_date }}">
        <button type="submit" style="margin-left: 20px;">Update Report</button>
    </form>

    <!-- Summary by Item -->
    <div class="report-section">
        <h2>Summary by Item</h2>
        <table>
            <thead>
                <tr>
                    <th>Item Description</th>
                    <th class="num">Tons Sold</th>
                    <th class="num">Revenue</th>
                </tr>
            </thead>
            <tbody>
                {% for item, values in summary_by_item %}
                <tr>
                    <td>{{ item }}</td>
                    <td class="num">{{ values.tons_sold | commas }}</td>
                    <td class="num">${{ values.revenue | commas }}</td>
                </tr>
                {% else %}
                <tr><td colspan="3" style="text-align: center;">No data for this period.</td></tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr class="total-row">
                    <td>Grand Total</td>
                    <td class="num">{{ summary_by_item | sum(attribute='1.tons_sold') | commas }}</td>
                    <td class="num">${{ summary_by_item | sum(attribute='1.revenue') | commas }}</td>
                </tr>
            </tfoot>
        </table>
    </div>

    <!-- Summary by Year -->
    <div class="report-section">
        <h2>Summary by Year</h2>
        <table>
            <thead>
                <tr>
                    <th>Year</th>
                    <th class="num">Tons Sold</th>
                    <th class="num">Revenue</th>
                </tr>
            </thead>
            <tbody>
                {% for year, values in summary_by_year %}
                <tr>
                    <td>{{ year }}</td>
                    <td class="num">{{ values.tons_sold | commas }}</td>
                    <td class="num">${{ values.revenue | commas }}</td>
                </tr>
                {% else %}
                <tr><td colspan="3" style="text-align: center;">No data for this period.</td></tr>
                {% endfor %}
            </tbody>
             <tfoot>
                <tr class="total-row">
                    <td>Grand Total</td>
                    <td class="num">{{ summary_by_year | sum(attribute='1.tons_sold') | commas }}</td>
                    <td class="num">${{ summary_by_year | sum(attribute='1.revenue') | commas }}</td>
                </tr>
            </tfoot>
        </table>
    </div>

    <!-- Detailed Report -->
    <div class="report-section">
        <h2>Detailed Report</h2>
        <table>
            <thead>
                <tr>
                    <th>Order No</th>
                    <th>Order Date</th>
                    <th>Customer Name</th>
                    <th>Item Code</th>
                    <th>Description</th>
                    <th class="num">Qty</th>
                    <th class="num">Unit Price</th>
                    <th class="num">Total</th>
                </tr>
            </thead>
            <tbody>
                {% for row in data %}
                <tr>
                    <td>{{ row.SalesOrderNo }}</td>
                    <td>{{ row.OrderDate }}</td>
                    <td>{{ row.CustomerName }}</td>
                    <td>{{ row.ItemCode or '' }}</td>
                    <td>{{ row.ItemCodeDesc or '' }}</td>
                    <td class="num">{{ (row.QuantityOrdered or 0.0) | commas }}</td>
                    <td class="num">${{ (row.UnitPrice or 0.0) | commas }}</td>
                    <td class="num">${{ (row.ExtensionAmt or 0.0) | commas }}</td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="8" style="text-align: center;">No sales data found for the selected date range.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% endblock %}
